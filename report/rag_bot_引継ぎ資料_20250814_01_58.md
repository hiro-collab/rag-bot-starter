
---

## 1) レポートを書き出す（Markdown）

````powershell
@'
# RAGボット 引き継ぎレポート（2025-08-14 / JST）

> 目的：**今日のセットアップ内容を、明日の別チャット（別担当）に渡して即再現できるように**まとめたドキュメント。  
> 対象OS：Windows 11 + PowerShell（pyenv-win／Poetry 使用）。

---

## 0. 今日の到達点（サマリ）
- プロジェクト：`rag-bot-starter/`
- Python：**3.13.5**（`pyenv local 3.13.5`）
- 依存管理：Poetry（`.venv/` はプロジェクト直下。Poetry/pip の **cache もプロジェクト直下**に退避）
- データ取得：`https://github.com/hiro-collab/book.git` → `LOCAL_REPO_DIR=./local_repo`
- チャンク化：`storage/chunks.jsonl`（**20 chunks**）
- ベクトルDB：Chroma（`storage/chroma/`）に **days_collection** 作成済み
- 検索テスト：`"環境構築とは何か"` で上位ヒットを確認
- 生成：**Ollama** をインストール済み（PATHは新ターミナルで反映 or 一時PATH追加）

---

## 1. 前提情報
### PC構成
- CPU: i7-12700KF / RAM: 32GB / GPU: **RTX 3070 8GB**
- OS: Windows 11 / TZ: Asia/Tokyo

### .env（主要項目）
```ini
GIT_REPO_URL=https://github.com/hiro-collab/book.git
LOCAL_REPO_DIR=./local_repo
CHROMA_DIR=./storage/chroma
TZ=Asia/Tokyo

# 生成バックエンド（どれか設定）
# OLLAMA_BASE_URL=http://localhost:11434
# OLLAMA_MODEL=qwen2.5:7b
# LMSTUDIO_BASE_URL=http://localhost:1234/v1
# LMSTUDIO_MODEL=Qwen2.5-7B-Instruct
# OPENAI_API_KEY=sk-...
````

---

## 2. 今日の作業ログ（再現コマンド）

PowerShell想定。必要に応じて行頭の `$` は外して実行。

### 2.1 Poetry 初期化 & キャッシュ回避

```powershell
$env:POETRY_CACHE_DIR = "$pwd\.poetry-cache"
$env:PIP_CACHE_DIR    = "$pwd\.pip-cache"
poetry config virtualenvs.in-project true
poetry init -n --name rag-bot-starter --description "Local RAG bot" --license MIT
pipx inject poetry python-certifi-win32
$req = Get-Content requirements.txt | Where-Object { $_ -and $_ -notmatch '^\s*#' }
poetry add $req
```

### 2.2 pyenv／仮想環境

```powershell
pyenv local 3.13.5
poetry run python -V
```

### 2.3 Git 整理（生成物を除外）

```powershell
ren gitignore .gitignore  # 必要なら
git rm -r -f --cached local_repo storage/chroma ingest/__pycache__ 2>$null
git add .gitignore .gitattributes
git commit -m "chore: ignore caches/venv/local_repo/vectorDB artifacts"  # 任意
```

### 2.4 データ同期 → チャンク化 → インデックス

```powershell
poetry run python -m ingest.fetch_repo
poetry run python -m ingest.split_markdown --repo .\local_repo --out .\storage\chunks.jsonl
poetry run python -m ingest.build_index --chunks .\storage\chunks.jsonl --db .\storage\chroma
poetry run python -c "import chromadb; c=chromadb.PersistentClient(path=r'.\storage\chroma'); print([col.name for col in c.list_collections()])"
```

### 2.5 検索テスト

```powershell
poetry run python -m rag.query_cli --db .\storage\chroma --q "環境構築とは何か"
```

### 2.6 生成バックエンド（Ollama 例）

```powershell
winget install -e --id Ollama.Ollama
# PATH反映：新しいPowerShellを開く or 一時追加
$paths = @("$env:ProgramFiles\Ollama", "$env:ProgramFiles\Ollama\bin"); foreach ($p in $paths) { if (Test-Path $p) { $env:PATH = "$p;$env:PATH" } }
ollama pull qwen2.5:7b
# .env を編集後：
poetry run python -m rag.draft_today --db .\storage\chroma --topic "環境の勉強"
```

---

## 3. 今日の問題と対応

* **PyPI接続エラー** → `python-certifi-win32` を `pipx inject poetry`、加えて **Poetry/pip の cache をプロジェクト直下**に変更。
* **`where` 無反応** → PowerShellでは `where.exe python` / `Get-Command python` を使用。
* **`ModuleNotFoundError: rag`** → `python -m rag.query_cli` の**モジュール実行**へ変更。
* **DuplicateIDError（Chroma）** → `split_markdown.py` を修正：相対パスを`/`で正規化、`seen_files`で二重走査回避、`blake2b`で**doc\_idを一意化**。
* **HuggingFace symlink 警告** → 実害なし。気になるなら `HF_HUB_DISABLE_SYMLINKS_WARNING=1`。

---

## 4. 変更コード（差分）

```diff
# ingest/split_markdown.py
+from hashlib import blake2b
 count = 0
 with open(out, "w", encoding="utf-8") as fw:
-    for md in iter_md_files(repo / "days"):
+    seen_files = set()
+    for target in [repo / "days", repo]:
+        if not target.exists():
+            continue
+        for md in iter_md_files(target):
+            rel_path = str(md.relative_to(repo)).replace("\\\\", "/")
+            if rel_path in seen_files:
+                continue
+            seen_files.add(rel_path)
             text = md.read_text(encoding="utf-8", errors="ignore")
             chunks = split_text(text)
             for idx, ch in enumerate(chunks):
-                doc = { "id": f"{md.stem}_{idx}", ... }
+                h = blake2b(ch.encode("utf-8"), digest_size=8).hexdigest()
+                doc_id = f"{rel_path}::{idx}::{h}"
+                doc = { "id": doc_id, ... }
                 fw.write(json.dumps(doc, ensure_ascii=False) + "\n")
                 count += 1
```

---

## 5. `.gitignore` / `.gitattributes`（要点）

`.gitignore`

```
.poetry-cache/
.pip-cache/
.venv/
local_repo/
storage/chroma/
storage/logs/
storage/chunks.jsonl
__pycache__/
*.pyc
```

`.gitattributes`

```
* text=auto eol=lf
*.sh  text eol=lf
*.py  text eol=lf
*.md  text eol=lf
*.bat text eol=crlf
*.ps1 text eol=crlf
*.png binary
*.zip binary
```

---

## 6. ロールバック／再作成

```powershell
Remove-Item .\storage\chunks.jsonl -Force -ErrorAction SilentlyContinue
Remove-Item .\storage\chroma -Recurse -Force -ErrorAction SilentlyContinue
poetry run python -m ingest.split_markdown --repo .\local_repo --out .\storage\chunks.jsonl
poetry run python -m ingest.build_index --chunks .\storage\chunks.jsonl --db .\storage\chroma
```

---

## 7. 次の一手

* Reranker 追加（`bge-reranker-v2-m3`）
* `draft_today.py` のテンプレ微調整
* Slack 承認フロー（Block Kit＋FastAPI）
* スケジューラ（APScheduler）
* X / Gmail 送信アダプタ
  '@ | Set-Content -Path .\RAG\_Bot\_Handover\_Report\_2025-08-14.md -Encoding UTF8

````

---

