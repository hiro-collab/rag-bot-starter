# RAG Bot 引継ぎ資料（2025-08-14 / Windows + Python3.12.10 + RTX3070, CUDA12.6）

> ざっくり言うと：**いまは「検索DB→Rerank→下書き生成」まで通ってる**。Ollama疎通、PowerShellのコツ、Poetry 2.x の挙動、改行LF統一、BGE(CUDA)の入れ方まで整理したで。困ったら **「トラブルシュート」** の章から読んでな。関西弁ちょい混ぜで書いとく。

---

## 1. 現状サマリ（どこまで動いてる？）
- **データ取り込み〜索引**：`ingest.fetch_repo → ingest.split_markdown → ingest.build_index(Chroma)` で `storage/chroma` 作成済み。
- **検索**：`python -m rag.query_cli --db storage/chroma --q ...` でヒット取得OK。
- **下書き生成**：`python -m rag.draft_today --topic ...` で **prompts/daily_ja.txt（300〜600字版）** を使い、**危険手順自動回避＋長さ調整**の上で `storage/drafts/` に保存。
- **Reranker**：CE(CrossEncoder) と **BGE(FlagEmbedding)** に対応。Windows/RTX3070 + **CUDA 12.6** では **torch 2.8.0 cu126** でGPU使用OK。
- **Ollama**：API疎通確認済み。PowerShellのJSONは**二重二重引用符**で投げるのがコツ。

---

## 2. 環境前提
- OS: Windows 11 / PowerShell
- Python: **3.12.10**（`pyenv local 3.12.10`）
- Poetry: 2.x（PEP621スタイル運用、**package-mode=false**）
- GPU: NVIDIA GeForce **RTX 3070 (Ampere)**、VRAM 8GB
- ドライバ: **CUDA 12.6 系**（Toolkitの入替は不要。PyTorchのCUDAホイールにランタイム同梱）

---

## 3. リポジトリ設定（改行と生成物）
- `.gitattributes`：基本LF、Windowsネイティブ（`.ps1/.cmd/.bat`）はCRLF固定。
- CRLF警告が出たら一回だけ正規化：
  ```powershell
  git config core.autocrlf false
  git config core.eol lf
  git config core.safecrlf warn

  # 生成物は無視（例）
  Add-Content .gitignore "storage/drafts/"
  Add-Content .gitignore "storage/chunks.jsonl"
  git rm -r --cached storage/drafts 2>$null
  git rm --cached storage/chunks.jsonl 2>$null

  git add --renormalize .
  git commit -m "Normalize line endings via .gitattributes; ignore generated drafts/chunks"
  ```

---

## 4. .env の扱い
- 置き場所：プロジェクト直下。
- Python側で読む：`from dotenv import load_dotenv; load_dotenv()`（既に各スクリプトで実装済み）。
- CLIで一時適用：`python -m dotenv run -- <cmd>`。
- PowerShellセッションに流し込むスニペット：
  ```powershell
  # scripts\load-dotenv.ps1（process-scope）
  Get-Content .env | ForEach-Object {
    if ($_ -match '^\s*#' -or $_.Trim().Length -eq 0) { return }
    if ($_ -match '^\s*([^=]+?)\s*=\s*(.*)\s*$') {
      $name=$matches[1].Trim(); $val=$matches[2].Trim()
      if ($val.StartsWith('"') -and $val.EndsWith('"')) { $val=$val.Substring(1,$val.Length-2) }
      elseif ($val.StartsWith("'") -and $val.EndsWith("'")) { $val=$val.Substring(1,$val.Length-2) }
      Set-Item -Path ("Env:" + $name) -Value $val
    }
  }
  ```

---

## 5. セットアップ（クリーン環境）
```powershell
# Python/Poetry 準備
pyenv local 3.12.10
poetry env use 3.12.10
poetry lock
poetry install
```

**`pyproject.toml` の要点（抜粋）**
```toml
[project]
requires-python = ">=3.12,<3.13"
dependencies = [
  "chromadb>=0.5.5",
  "sentence-transformers>=3.0.1",
  "python-dotenv>=1.0.1",
  "pydantic>=2.8.2",
  "slack-sdk>=3.31.0",
  "fastapi>=0.112.2",
  "uvicorn>=0.30.6",
  "requests>=2.32.3",
  "FlagEmbedding>=1.3.5,<2.0.0",
  "torch>=2.8.0,<3.0.0"
]

[tool.poetry]
package-mode = false

[[tool.poetry.source]]
name = "pytorch-cu126"
url  = "https://download.pytorch.org/whl/cu126"
priority = "supplemental"
```

**CUDA 12.6（cu126）版 torch を入れる**
```powershell
poetry remove torch
poetry add --source pytorch-cu126 torch==2.8.0
poetry add FlagEmbedding
```

**GPUを掴めてるか確認**
```powershell
poetry run python -c "import torch;print(torch.__version__);print('cuda?',torch.cuda.is_available());print('cuda',torch.version.cuda)"
```

---

## 6. データ取り込み → 索引作成
```powershell
# レポジトリ取得（.envのGIT_REPO_URL/LOCAL_REPO_DIRを使用）
poetry run python -m ingest.fetch_repo

# Markdown → チャンク化
poetry run python -m ingest.split_markdown --repo .\local_repo --out .\storage\chunks.jsonl

# Chroma へインデックス
poetry run python -m ingest.build_index --chunks .\storage\chunks.jsonl --db .\storage\chroma
```

---

## 7. 検索確認（Reranker込み）
```powershell
# -m 実行（rag/__init__.py 必須）
poetry run python -m rag.query_cli `
  --db storage/chroma `
  --q "環境構築とは何か" `
  --k 10 `
  --rerank `
  --rrk-backend bge `
  --rrk-top 6
```
> CEで軽く回すなら `--rrk-backend` は省略（既定=ce）。

---

## 8. 下書き生成（安全ガード付き）
- テンプレ：`prompts/daily_ja.txt`（**300〜600字**、出力のみ返す、危険操作禁止の明示を推奨）
- スクリプト：`rag/draft_today.py`
  - **危険手順検出 → 再生成 → 最終フォールバック**
  - **長さ調整（300〜600字、改行除外カウント）**
  - 保存：`storage/drafts/YYYYMMDD_HHMMSS_topic.txt` ＋ `storage/logs/last_draft.txt`

**実行例**
```powershell
poetry run python -m rag.draft_today `
  --db storage/chroma `
  --topic "環境の勉強" `
  --template prompts/daily_ja.txt `
  --k 10 `
  --rerank `
  --rrk-backend bge `
  --rrk-top 6
```

---

## 9. 再現スクリプト（配布用）
- `reproduce_2025-08-14.ps1` を同梱。**Here-String → Set-Content** で生成したやつ。
- 実行：
  ```powershell
  powershell -ExecutionPolicy Bypass -File .\reproduce_2025-08-14.ps1
  ```

---

## 10. トラブルシュート（ようあるやつ）
- **`ModuleNotFoundError: No module named 'rag'`** → `python -m rag.query_cli` の **-m実行**。`rag/__init__.py` を置く。
- **PowerShellのcurlで JSON 失敗** → `"` ではなく **`""`** で二重引用、もしくは `Invoke-RestMethod` を使う。
- **`model '' not found`** → `$env:OLLAMA_MODEL` が空。`.env` をセッションへ読み込み or 直接モデル名を書く。
- **`zlib-state` ビルド失敗（3.13）** → Pythonを **3.12系** へ（今回は **3.12.10**）。
- **`poetry install` で root パッケージが無い** → `package-mode = false` または `--no-root`。
- **CRLF警告** → 「3. リポジトリ設定」の正規化手順を実行。
- **BGEが重い/VRAM厳しい** → `--k 8` / `--rrk-top 4`、一時的に `.env` を `RERANKER_DEVICE=cpu`、もしくは **CE** に切替。
- **CUDA版の不一致** → ドライバ12.6なら **cu126** を選択。将来ドライバを12.8+に上げたら **cu128** へ切替可。

---

## 11. 次の一手（すぐやれる）
- **Slack承認フロー**：`SLACK_BOT_TOKEN` と `APPROVER_SLACK_USER_ID` を `.env` に。`adapters/post_slack.py` を用意して `last_draft.txt` を一時チャンネルへ投げ、✅リアクションで確定投稿。
- **定時実行**：Windows Task Scheduler で 09:00 / 13:00 / 20:00 に `python -m rag.draft_today ...` を実行。
- **BM25 fallback**：`rank_bm25` で初段ヒットを軽く並べ替え → CE/BGE へ渡す二段リランクに。

---

## 12. 運用Tips（安全第一でいこ）
- 「今日の一歩」は **破壊的操作（削除/アンインストール/初期化/上書き/レジストリ変更）禁止**。**検証は新規ディレクトリ/仮想環境**でやる。
- PowerShell の **行継続はバッククォート**（`` ` ``）。`^` は cmd.exe 用。
- 出力が文字数オーバーしがちなときはテンプレに **「出力のみ返す。前置き禁止」** を一行足すと安定。

---

## 13. 付録（主なファイル）
- `prompts/daily_ja.txt`：本番テンプレ（300〜600字）。
- `rag/draft_today.py`：危険手順自動回避 & 長さ調整付き生成。
- `rag/reranker.py`：CE/BGE 切替のプラガブル実装。
- `rag/query_cli.py`：`--rerank` オプション追加済み。
- `scripts/load-dotenv.ps1`：PowerShellで `.env` をセッションに流し込む補助。
- `reproduce_2025-08-14.ps1`：再現用スクリプト。
- `pyproject.toml`：PEP621、`package-mode=false`、`pytorch-cu126` ソース登録。
- `.gitattributes`：LF基準、WindowsスクリプトのみCRLF。
- `.env`：Ollama/Slack/Reranker などの設定。

---

### 最後に
ここまでやっとけば、**DB更新→Rerank→下書き**が毎回同じ手順で再現できるはず。次に渡す人は、

1) Python/Poetry を整える → 2) `.env` を読む → 3) `ingest.*` → 4) `query_cli` → 5) `draft_today`（必要なら `--rerank`）

の順でいけばOKや。なんか詰まったら、この資料の **10. トラブルシュート** だけでも見てくれたら、だいたい抜けられるで。

